import json

import pandas

from .writer import Writer
from src.dataset_conversion.data.data_structure import DataStructure
from ..data.file_change import FileChange

HEADER = ['', 'authentication_required', 'availability_impact', 'cve_id',
          'cve_page', 'cwe_id', 'access_complexity', 'confidentiality_impact', 'integrity_impact', 'publish_date',
          'score', 'summary', 'update_date', 'vulnerability_classification', 'ref_link', 'commit_id',
          'commit_message', 'files_changed', 'lang', 'project', 'version_after_fix', 'version_before_fix']


class BigVulWriter(Writer):
    def write_file(self):
        with open(self.file_path, 'w') as output_file:
            for n, element in enumerate(self.reader.read_file()):
                field = self.convert_to_big_vul(element)
                if n == 0:
                    field.to_csv(output_file, header=HEADER, index=False)
                else:
                    field.to_csv(output_file, header=False, index=False)

    def convert_files_changed(self, files_changed: list[FileChange]) -> str:
        result = '<_**next**_>'.join(json.dumps(file.dict()) for file in files_changed)
        return result

    def convert_to_big_vul(self, field: DataStructure) -> pandas.DataFrame:
        data_dict = dict(
            zip(HEADER, [[field.index], [field.authentication_required],
                         [field.availability], [field.cve_id], [field.cve_page], [field.cwe_id], [field.complexity],
                         [field.confidentiality], [field.integrity], [field.publish_date],
                         [field.score], [field.summary], [field.update_date],
                         [field.vulnerability_classification],
                         [field.codeLink], [field.commit_id], [field.commit_message],
                         [self.convert_files_changed(field.files_changed)],
                         [field.lang], [field.project], [field.project_after],
                         [field.project_before]]))
        return pandas.DataFrame.from_dict(data_dict)
